<ui:composition xmlns="http://www.w3.org/1999/xhtml"
   xmlns:ui="http://java.sun.com/jsf/facelets"
   xmlns:c="http://java.sun.com/jstl/core"
   xmlns:h="http://java.sun.com/jsf/html"
   xmlns:f="http://java.sun.com/jsf/core" 
   xmlns:a4j="http://richfaces.org/a4j"
   xmlns:rich="http://richfaces.org/rich"
   xmlns:s="http://jboss.com/products/seam/taglib">
   
	<c:set var="edit" value="#{segnalazione.id eq null or alertingController.taskAssignee}"/>
	
	<s:decorate template="/layout/input.xhtml" rendered="#{not s:hasRole('cittadino') and ((segnalazione.id ne null and segnalazione.cittadino ne null) or (segnalazione.id eq null))}">
		<ui:define name="label">Cittadino</ui:define>
		<s:decorate  template="/layout/actions.xhtml">
		
		<h:outputText rendered="#{segnalazione.cittadino ne null}" value="#{segnalazione.cittadino}"/>
		<s:button rendered="#{segnalazione.id eq null}"  propagation="none" view="/app/utenti/CittadinoList.xhtml"
			value="#{segnalazione.cittadino eq null ? 'Scegli un cittadino' : 'Cambia'}"/>
		</s:decorate>
	</s:decorate>

	<s:decorate template="/layout/input.xhtml" rendered="#{segnalazione.id eq null}">
		<ui:define name="label">Oggetto</ui:define>
		<h:inputText  required="true" size="80"
		value="#{segnalazione.oggetto}"/>
	</s:decorate>
	
<!--	<s:decorate template="/layout/input.xhtml" rendered="# {s:hasRole('cittadino') and segnalazione.id eq null}">-->
<!--		<ui:define name="label">Risposte</ui:define>-->
<!--		Non voglio ricevere risposte per questa segnalazione-->
<!--		<h:selectBooleanCheckbox value="# {segnalazione.noreply}" />-->
<!--	</s:decorate>-->
<!--	-->
<!--	<s:decorate template="/layout/input.xhtml" rendered="# {segnalazione.noreply}">-->
<!--		Non voglio ricevere risposte per questa segnalazione-->
<!--	</s:decorate>-->

	<s:decorate template="/layout/input.xhtml" rendered="#{segnalazione.id eq null}">
		<ui:define name="label">Descrizione</ui:define>
		<h:inputTextarea required="true"
		value="#{segnalazione.messaggio}" />
	</s:decorate>
	
	<s:decorate template="/layout/input.xhtml" rendered="#{edit and segnalazione.id ne null and not s:hasRole('cittadino')}">
		<ui:define name="label">Nuovo Messaggio</ui:define>
		<h:inputTextarea value="#{segnalazioneHome.newMessage}" />
	</s:decorate>
	

<s:fragment rendered="#{not s:hasRole('cittadino') and segnalazione.cittadino eq null}">
	<s:decorate template="/layout/input.xhtml" rendered="#{edit}">
		<ui:define name="label">Referente</ui:define>
		<div class="elementoIndirizzo">
		Nome: <h:inputText size="40" required="true"
		value="#{segnalazione.referente}" />
		</div>
		<div class="elementoIndirizzo">
		Telefono: <h:inputText size="15" required="true"
		value="#{segnalazione.telefonoReferente}" />
		</div>
	</s:decorate>
	
	<s:decorate template="/layout/input.xhtml" rendered="#{!edit}">
		<ui:define name="label">Referente</ui:define>
		#{segnalazione.referente} #{segnalazione.telefonoReferente}
	</s:decorate>
	
	<s:decorate template="/layout/input.xhtml" rendered="#{edit and s:hasRole('smistatore')}">
		<ui:define name="label">Scadenza</ui:define>	
		Data di inserimento: &#160;<rich:calendar required="true" value="#{segnalazione.data}" datePattern="dd/MM/yyyy"/>
		<br/>
		<br/>
		Data di scadenza: &#160;<rich:calendar required="true" value="#{segnalazione.scadenza}" datePattern="dd/MM/yyyy"/>
    </s:decorate>

	<s:decorate template="/layout/input.xhtml" rendered="#{!(edit and s:hasRole('smistatore'))}">
		<ui:define name="label">Inserimento</ui:define>	
		<h:outputText value="#{segnalazione.data}"><s:convertDateTime pattern="dd/MM/yyyy" /></h:outputText>
    </s:decorate>
	<s:decorate template="/layout/input.xhtml" rendered="#{!(edit and s:hasRole('smistatore'))}">
		<ui:define name="label">Scadenza</ui:define>	
		<h:outputText value="#{segnalazione.scadenza}"><s:convertDateTime pattern="dd/MM/yyyy" /></h:outputText>
    </s:decorate>
	<s:decorate template="/layout/input.xhtml" rendered="#{!edit}">
		<ui:define name="label">Chiusura</ui:define>	
		<h:outputText value="#{segnalazione.chiusura}"><s:convertDateTime pattern="dd/MM/yyyy" /></h:outputText>
    </s:decorate>

	

	<s:decorate id="utenzaDecoration" template="/layout/input.xhtml" rendered="#{edit}">
    	<ui:define name="label">Utenza</ui:define>
		<rich:dropDownMenu styleClass="priorityMenu">
 <f:facet name="label">
    	  <s:div>

    	      	  <h:outputText value="#{segnalazione.utenza ne null ? segnalazione.utenza : 'Scegli un\'utenza'}"/>
    	  </s:div>
    	  </f:facet>
    	  <rich:menuItem submitMode="ajax"
									limitToList="true" ajaxSingle="true"
									action="#{segnalazioneHome.setUtenza(null)}"
									reRender="utenzaDecoration" value="Nessuna Utenza"
									/>
    	  <c:forEach items="#{categoriaUtenzaList.resultList}" var="cu">
				<rich:menuGroup value="#{cu.nome}" rendered="#{not empty cu.sottocategorie}">
					<c:forEach items="#{cu.sottocategorie}" var="sc">
						<rich:menuGroup value="#{sc.nome}" rendered="#{not empty sc.utenze}">
							<c:forEach items="#{sc.utenze}" var="u">
								<rich:menuItem submitMode="ajax"
									limitToList="true" ajaxSingle="true"
									action="#{segnalazioneHome.setUtenza(u)}"
									reRender="utenzaDecoration" value="#{u.descrizione}"
									/>
							</c:forEach>
						<rich:menuItem submitMode="ajax"
									limitToList="true" ajaxSingle="true"
									action="#{segnalazioneHome.setSottocategoriaUtenza(sc)}"
									reRender="utenzaDecoration" value="#{sc.nome} - tutte le utenze"
									/>
						</rich:menuGroup>
					</c:forEach>
				<rich:menuItem submitMode="ajax"
									limitToList="true" ajaxSingle="true"
									action="#{segnalazioneHome.setCategoriaUtenza(cu)}"
									reRender="utenzaDecoration" value="#{cu.nome} - tutte le utenze"
									/>
				</rich:menuGroup>
			</c:forEach>
		 </rich:dropDownMenu>
	</s:decorate>

	<s:decorate template="/layout/input.xhtml" rendered="#{!edit}">
		<ui:define name="label">Utenza</ui:define>
		<s:fragment rendered="#{segnalazione.utenza ne null}" >#{segnalazione.utenza.descrizione}</s:fragment>	
		<s:fragment rendered="#{segnalazione.sottocategoriaUtenza ne null}" >#{segnalazione.sottocategoriaUtenza.nome} - tutte le utenze</s:fragment>	
		<s:fragment rendered="#{segnalazione.categoriaUtenza ne null}" >#{segnalazione.utenza.descrizione} - tutte le utenze</s:fragment>	
		
    </s:decorate>

</s:fragment>

	<s:decorate  template="/layout/input.xhtml"  rendered="#{edit and not s:hasRole('cittadino')}">
    	<ui:define name="label">Tipologia</ui:define>
		<h:selectOneRadio required="true" layout="pageDirection"
			value="#{segnalazione.sottotipoSegnalazione}">

			<s:selectItems value="#{sottotipoSegnalazioneList.resultList}"
					var="tipo" label="#{tipo.descrizione}"/>
			<s:convertEntity/>
		</h:selectOneRadio>
	</s:decorate>
	
	<s:decorate  template="/layout/input.xhtml"  rendered="#{!edit}">
    	<ui:define name="label">Tipologia</ui:define>
    	#{segnalazione.sottotipoSegnalazione}
	</s:decorate>


	<s:decorate id="inddec" template="/layout/input.xhtml" rendered="#{edit}">
		<ui:define name="label">Luogo della Segnalazione</ui:define>
	<table>
		<tr>
			<td valign="top">
			<a4j:region id="indreg">
			<script type="text/javascript">
            function fillCombo(output, sg){  
                output.comboList.itemsText=sg.getSelectedItems().pluck('civiciString').toString().split(',');
                output.comboList.createDefaultList();
            }
   			</script>
			Indirizzo:&#160;<h:inputText id="indvia" size="40" value="#{segnalazione.via}" >
			</h:inputText>
			
			<div id="loading" style="width:100%;text-align:right;display:none">
				Caricamento elenco indirizzi...
			</div>
			
			<rich:suggestionbox id="suggestion" 
				requestDelay="800"
				immediate="true"
				usingSuggestObjects="true"
				for="indvia" height="128" 
				width="256" 
				var="result" 
				minchars="2"
				eventsQueue="suggestion"
				onselect="fillCombo(#{rich:component('civcombo')}, #{rich:component('suggestion')});"
				suggestionAction="#{segnalazioneHome.indirizzi}">
				<h:column>
					#{result.strada}
				</h:column>	
				
			</rich:suggestionbox>
			<a4j:status for="indreg" onstart="document.getElementById('loading').style.display='block'"
			onstop="document.getElementById('loading').style.display='none'"/>
			</a4j:region>
			</td>
			<td valign="top">
			
				Civico:&#160;
				</td><td>
				
				<rich:comboBox  id="civcombo" width="70" value="#{segnalazione.civico}"/>
			
			</td>
			<td valign="top">
			Localit&#224;:&#160;<h:inputText value="#{segnalazione.localita}" />
			</td>
			<td valign="top">
			Comune:&#160;<h:inputText value="#{segnalazione.comune}" />
			</td>
		</tr>
	</table>
		
	</s:decorate>
	<s:decorate template="/layout/input.xhtml" rendered="#{edit}">
		<ui:define name="label">Ubicazione</ui:define>
		<p>Se pertinente, oppure se il luogo non ha un indirizzo, inserire una descrizione</p>
		<h:inputTextarea value="#{segnalazione.ubicazione}"/>
    </s:decorate>
    
    <s:decorate template="/layout/input.xhtml" rendered="#{!edit}">
    	<ui:define name="label">Luogo della Segnalazione</ui:define>
		#{segnalazione.via}, #{segnalazione.civico} - #{segnalazione.localita} #{segnalazione.comune}
		<br/>
		#{segnalazione.ubicazione}
    </s:decorate>

	<s:decorate template="/layout/input.xhtml" rendered="#{not s:hasRole('cittadino') and edit}">
		<ui:define name="label">Canale di inserimento</ui:define>
		<h:selectOneRadio required="true" layout="pageDirection"
			value="#{segnalazione.canaleSegnalazione}">
			<s:selectItems value="#{canaleSegnalazioneList.resultList}"
					var="tipo" label="#{tipo.descrizioneCanale}"/>
			<s:convertEntity/>
		</h:selectOneRadio>
		
    </s:decorate>
    
    
    <s:decorate template="/layout/input.xhtml" rendered="#{not s:hasRole('cittadino') and !edit}">
		<ui:define name="label">Canale di inserimento</ui:define>
		#{segnalazione.canaleSegnalazione}
    </s:decorate>

	<s:decorate template="/layout/input.xhtml" rendered="#{not s:hasRole('cittadino') and edit}">
		<ui:define name="label">Canale di risposta</ui:define>
		<h:selectOneRadio required="true" layout="pageDirection"
			value="#{segnalazione.canaleRisposta}">
			<s:selectItems value="#{canaleSegnalazioneList.resultList}"
					var="tipo" label="#{tipo.descrizioneCanale}"/>
			<s:convertEntity/>
		</h:selectOneRadio>
		
    </s:decorate>
    
    
    <s:decorate template="/layout/input.xhtml" rendered="#{not s:hasRole('cittadino') and !edit}">
		<ui:define name="label">Canale di risposta</ui:define>
		#{segnalazione.canaleRisposta}
    </s:decorate>
    
    <s:decorate  template="/layout/display.xhtml" rendered="#{!edit}">
    	<ui:define name="label">Inserita da</ui:define>
    	<h:outputText value="#{segnalazioneHome.instance.idutenteInseritore}" >
    	<f:converter converterId="usernameConverter" />
    	</h:outputText>
	</s:decorate>
    
    <s:decorate template="/layout/input.xhtml" rendered="#{segnalazione.sottotipoSegnalazione ne null and (not s:hasRole('cittadino') and edit and segnalazione.id ne null)}">
		<ui:define name="label">Stato segnalazione</ui:define>
		<h:selectOneRadio required="true" layout="pageDirection"
			value="#{segnalazione.stato}">
			<s:selectItems value="#{segnalazione.sottotipoSegnalazione.tipoSegnalazione.stati4Update}"
					var="stato" label="#{stato.descrizione}"/>
			<s:convertEntity/>
		</h:selectOneRadio>
    </s:decorate>
    
    <s:decorate template="/layout/input.xhtml" rendered="#{not (not s:hasRole('cittadino') and edit and segnalazione.id ne null)}">
		<ui:define name="label">Stato segnalazione</ui:define>
		#{segnalazione.stato.descrizione}
		
    </s:decorate>
    
    
    <s:decorate template="/layout/actions.xhtml" rendered="#{edit and segnalazione.id ne null}">
             <h:commandButton value="Aggiorna Segnalazione"
                    action="#{segnalazioneHome.update}" />
	</s:decorate>

    
    
</ui:composition>